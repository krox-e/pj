<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Estoque - Projeto Social</title>
    <!-- Carrega Tailwind CSS para estiliza√ß√£o r√°pida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        /* Estilos de barra de progresso customizada com cores de esperan√ßa/crescimento */
        .progress-bar-container { background-color: #e0f2f1; /* Light Teal Background */ }
        .progress-bar-fill { 
            transition: width 0.5s ease-in-out; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        /* Efeito sutil de eleva√ß√£o para as se√ß√µes */
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="bg-white p-6 rounded-3xl card-shadow mb-8 border-t-4 border-teal-400">
            <h1 class="text-4xl font-extrabold text-teal-600">Ajudar Faz Bem</h1>
            <p class="text-gray-500 mt-1 font-medium">Painel de Acompanhamento: Transformando Metas em Realidade.</p>
            <!-- Status de armazenamento local com tom positivo -->
            <div id="auth-status" class="mt-4 text-sm text-sky-600 font-semibold">Os dados est√£o salvos com seguran√ßa no seu navegador.</div>
        </header>

        <!-- Se√ß√£o de Distribui√ß√£o de Cestas (Mais vibrante) -->
        <div class="bg-white p-6 rounded-2xl card-shadow mb-8">
            <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                Meta de Impacto Social 
                <svg class="w-6 h-6 text-yellow-500 ml-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118l-2.8-2.034c-.783-.57-.381-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
            </h2>
            <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-6">
                <div class="flex-grow w-full md:w-auto">
                    <p class="text-sm font-medium text-gray-500">Fam√≠lias Alcan√ßadas:</p>
                    <p id="total-baskets" class="text-5xl font-extrabold text-teal-600">0</p>
                </div>
                <div class="w-full md:w-auto">
                    <!-- Bot√£o verde √°gua (teal) -->
                    <button id="add-basket-btn" class="w-full md:w-auto bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.02]">
                        + 1 Fam√≠lia Ajudada
                    </button>
                </div>
            </div>
        </div>

        <!-- Formul√°rio para Adicionar Novo Item ou Atualizar Estoque -->
        <div class="bg-white p-6 rounded-2xl card-shadow mb-8">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Gerenciar Arrecada√ß√µes</h2>
            <form id="item-form" class="space-y-4">
                <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                    <input type="text" id="item-name" placeholder="Nome do Item (Ex: Feij√£o Preto 1kg)" required
                           class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-teal-500 focus:border-teal-500">
                    <input type="number" id="item-stock" placeholder="Estoque Atual (Unidades)" required min="0" value="0"
                           class="w-full md:w-1/4 p-3 border border-gray-300 rounded-xl focus:ring-teal-500 focus:border-teal-500">
                    <input type="number" id="item-goal" placeholder="Meta de Arrecada√ß√£o" required min="1" value="100"
                           class="w-full md:w-1/4 p-3 border border-gray-300 rounded-xl focus:ring-teal-500 focus:border-teal-500">
                </div>
                <!-- Bot√£o de submiss√£o verde esmeralda (emerald) -->
                <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-md transition duration-150 ease-in-out">
                    Salvar Novo Item / Atualizar Estoque
                </button>
            </form>
        </div>

        <!-- Lista de Itens em Tempo Real -->
        <div class="bg-white p-6 rounded-2xl card-shadow">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Progresso de Arrecada√ß√£o</h2>
            <div id="inventory-list" class="space-y-4">
                <p class="text-center text-gray-500 italic">Nenhum item cadastrado ainda. Use o formul√°rio acima!</p>
            </div>
        </div>
    </div>

    <!-- Custom Modal/Dialog Structure (Substitui alert, prompt e confirm) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4 transform transition-all duration-300 scale-95" id="modal-content">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-3"></h3>
            <p id="modal-message" class="text-sm text-gray-600 mb-4"></p>
            <div id="modal-input-container" class="mb-4 hidden">
                <input type="number" id="modal-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Digite o valor">
            </div>
            <div id="modal-actions" class="flex justify-end space-x-2">
                <!-- Bot√µes gerados dinamicamente pelo JS -->
            </div>
        </div>
    </div>

    <script type="module">
        // Estruturas de dados globais e chaves de localStorage
        let inventory = [];
        let totalBaskets = 0;
        const INVENTORY_KEY = 'localInventory';
        const BASKETS_KEY = 'localBaskets';

        // --- Fun√ß√µes de Manipula√ß√£o de Dados (localStorage) ---

        /**
         * Carrega o invent√°rio e o contador de cestas do localStorage.
         */
        const loadData = () => {
            const storedInventory = localStorage.getItem(INVENTORY_KEY);
            inventory = storedInventory ? JSON.parse(storedInventory) : [];

            const storedBaskets = localStorage.getItem(BASKETS_KEY);
            totalBaskets = storedBaskets ? parseInt(storedBaskets) : 0;
        };

        /**
         * Salva o array de invent√°rio no localStorage.
         */
        const saveInventory = () => {
            localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));
            refreshUI(); // Atualiza a interface ap√≥s salvar
        };

        /**
         * Salva o contador de cestas no localStorage.
         */
        const saveBaskets = () => {
            localStorage.setItem(BASKETS_KEY, totalBaskets);
            refreshUI(); // Atualiza a interface ap√≥s salvar
        };

        /**
         * Encontra um item no array de invent√°rio pelo ID.
         * @param {string} itemId - O ID do item.
         * @returns {object | undefined} O objeto do item ou undefined.
         */
        const findItem = (itemId) => {
            return inventory.find(item => item.id === itemId);
        };

        // --- Fun√ß√µes de UI e Renderiza√ß√£o ---

        const inventoryListElement = document.getElementById('inventory-list');

        /**
         * Renderiza a lista completa de invent√°rio na interface.
         */
        const renderInventoryList = () => {
            inventoryListElement.innerHTML = '';
            
            if (inventory.length === 0) {
                inventoryListElement.innerHTML = '<p class="text-center text-gray-500 italic">Nenhum item cadastrado ainda. Use o formul√°rio acima!</p>';
                return;
            }

            // Ordena o invent√°rio para que itens abaixo da meta fiquem no topo
            const sortedInventory = [...inventory].sort((a, b) => {
                const percA = (a.stock / a.goal) * 100;
                const percB = (b.stock / b.goal) * 100;
                // Itens abaixo de 100% v√™m primeiro, do menor para o maior percentual
                if (percA < 100 && percB >= 100) return -1;
                if (percA >= 100 && percB < 100) return 1;
                return percB - percA; // Do mais longe para o mais perto
            });

            sortedInventory.forEach((item) => {
                renderItem(item, inventoryListElement);
            });
        };
        
        /**
         * Atualiza o contador de cestas e a lista de invent√°rio na UI.
         */
        const refreshUI = () => {
            document.getElementById('total-baskets').textContent = totalBaskets.toLocaleString('pt-BR');
            renderInventoryList();
        };

        /**
         * Renderiza um item individual dentro de um container.
         */
        const renderItem = (item, container) => {
            const percentage = Math.min(100, (item.stock / item.goal) * 100);
            
            // Cores mais alegres: verde √°gua para sucesso, azul c√©u para progresso
            const bgColor = percentage >= 100 ? 'bg-emerald-500' : 'bg-sky-400';
            const progressMessage = percentage >= 100 ? 
                                    'Meta Atingida! üéâ' : 
                                    `${(item.goal - item.stock).toLocaleString('pt-BR')} restantes para a meta.`;

            const itemCard = document.createElement('div');
            // Estilo do card atualizado
            itemCard.className = 'bg-white p-4 rounded-xl border-l-4 border-teal-400 flex flex-col md:flex-row items-start md:items-center justify-between shadow-md transition hover:shadow-lg';
            
            itemCard.innerHTML = `
                <div class="flex-1 min-w-0 mb-3 md:mb-0">
                    <p class="text-lg font-bold text-gray-800 truncate">${item.name}</p>
                    <p class="text-sm text-gray-500 mt-1">
                        <span class="font-semibold text-teal-600">${item.stock}</span> 
                        unidades em estoque / Meta: ${item.goal}
                    </p>
                    <div class="mt-2 h-3 w-full rounded-full progress-bar-container">
                        <div class="progress-bar-fill h-full rounded-full ${bgColor}" style="width: ${percentage}%;"></div>
                    </div>
                    <p class="text-xs font-medium mt-1 ${percentage >= 100 ? 'text-emerald-700' : 'text-sky-600'}">
                        ${percentage.toFixed(1)}% | ${progressMessage}
                    </p>
                </div>
                <div class="flex space-x-2 mt-3 md:mt-0">
                    <button data-id="${item.id}" class="update-stock-btn bg-sky-500 hover:bg-sky-600 text-white text-xs font-semibold py-2 px-3 rounded-lg shadow-md transition duration-150 ease-in-out flex items-center">
                        + Estoque
                    </button>
                    <button data-id="${item.id}" class="delete-item-btn bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-2 px-3 rounded-lg shadow-md transition duration-150 ease-in-out flex items-center">
                        Excluir
                    </button>
                </div>
            `;
            container.appendChild(itemCard);

            // Adiciona listeners aos bot√µes
            itemCard.querySelector('.update-stock-btn').addEventListener('click', (e) => {
                const itemId = e.currentTarget.getAttribute('data-id');
                const existingItem = findItem(itemId);
                if (existingItem) {
                    showPrompt(
                        'Atualizar Estoque',
                        `Digite a nova quantidade total para ${existingItem.name} (atual: ${existingItem.stock}):`,
                        existingItem.stock,
                        (newStock) => {
                            if (newStock !== null && !isNaN(parseInt(newStock))) {
                                updateItem(itemId, parseInt(newStock));
                            }
                        }
                    );
                }
            });

            itemCard.querySelector('.delete-item-btn').addEventListener('click', (e) => {
                const itemId = e.currentTarget.getAttribute('data-id');
                const existingItem = findItem(itemId);
                if (existingItem) {
                    showConfirmation(
                        'Confirmar Exclus√£o',
                        `Tem certeza que deseja excluir o item "${existingItem.name}"?`,
                        () => {
                            deleteItem(itemId);
                        }
                    );
                }
            });
        };
        
        // --- Custom Modal Functions (Mantidas como no c√≥digo anterior) ---

        const modalElement = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalActions = document.getElementById('modal-actions');
        const modalInputContainer = document.getElementById('modal-input-container');
        const modalInput = document.getElementById('modal-input');

        const hideModal = () => {
            modalElement.classList.add('hidden');
            modalInputContainer.classList.add('hidden');
            modalInput.value = '';
            modalActions.innerHTML = '';
        };

        const showModal = (title, message) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Bot√£o OK com a nova cor prim√°ria
            const okBtn = document.createElement('button');
            okBtn.textContent = 'OK';
            okBtn.className = 'bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-xl';
            okBtn.onclick = hideModal;
            
            modalActions.appendChild(okBtn);
            modalElement.classList.remove('hidden');
        };

        const showConfirmation = (title, message, onConfirm) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.className = 'text-gray-600 hover:bg-gray-100 font-bold py-2 px-4 rounded-xl';
            cancelBtn.onclick = hideModal;
            
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'Confirmar';
            confirmBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl';
            confirmBtn.onclick = () => {
                hideModal();
                onConfirm();
            };
            
            modalActions.appendChild(cancelBtn);
            modalActions.appendChild(confirmBtn);
            modalElement.classList.remove('hidden');
        };
        
        const showPrompt = (title, message, initialValue, onConfirm) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalInputContainer.classList.remove('hidden');
            modalInput.value = initialValue;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.className = 'text-gray-600 hover:bg-gray-100 font-bold py-2 px-4 rounded-xl';
            cancelBtn.onclick = () => {
                hideModal();
                onConfirm(null); 
            };
            
            // Bot√£o de atualiza√ß√£o com a nova cor de sucesso
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'Atualizar';
            confirmBtn.className = 'bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-xl';
            confirmBtn.onclick = () => {
                const value = modalInput.value;
                hideModal();
                onConfirm(value);
            };
            
            modalActions.appendChild(cancelBtn);
            modalActions.appendChild(confirmBtn);
            modalElement.classList.remove('hidden');
            modalInput.focus();
        };

        // --- L√≥gica de Neg√≥cios ---

        /**
         * Salva ou atualiza um item no array local.
         */
        const handleItemSubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('item-name').value.trim();
            const stock = parseInt(document.getElementById('item-stock').value);
            const goal = parseInt(document.getElementById('item-goal').value);

            if (!name || isNaN(stock) || isNaN(goal) || goal < 1) {
                showModal('Erro', 'Por favor, preencha todos os campos corretamente. A meta deve ser no m√≠nimo 1.');
                return;
            }

            // Usa o nome (normalizado) como ID √∫nico local
            const itemId = name.toLowerCase().replace(/[^a-z0-9]+/g, '_');
            
            const existingIndex = inventory.findIndex(item => item.id === itemId);

            const newItemData = { id: itemId, name, stock, goal };

            if (existingIndex > -1) {
                // Atualiza item existente
                inventory[existingIndex] = newItemData;
            } else {
                // Adiciona novo item
                inventory.push(newItemData);
            }
            
            document.getElementById('item-form').reset();
            saveInventory();
            showModal('Sucesso', `Item "${name}" salvo/atualizado com sucesso!`);
        };

        /**
         * Atualiza apenas o estoque de um item.
         */
        const updateItem = (itemId, newStock) => {
            const index = inventory.findIndex(item => item.id === itemId);
            if (index > -1) {
                inventory[index].stock = newStock;
                saveInventory();
            }
        };

        /**
         * Exclui um item.
         */
        const deleteItem = (itemId) => {
            inventory = inventory.filter(item => item.id !== itemId);
            saveInventory();
        };

        /**
         * Adiciona uma cesta distribu√≠da.
         */
        const handleAddBasket = () => {
            totalBaskets += 1;
            saveBaskets();
        };

        // --- Inicializa√ß√£o e Event Listeners ---
        
        // Carrega os dados iniciais do localStorage ao carregar a p√°gina
        window.onload = () => {
            loadData();
            refreshUI();
        };

        document.getElementById('item-form').addEventListener('submit', handleItemSubmit);
        document.getElementById('add-basket-btn').addEventListener('click', handleAddBasket);
    </script>

</body>
</html>
